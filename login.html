<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <link rel="icon" type="image/x-icon" href="/MultiTools.jpg" />
  <meta name="theme-color" content="#45a049" />
  <link rel="manifest" href="/manifest.json" />

  <!-- ===========================
       Content Security Policy
       (adjust connect-src/script-src if you add other trusted third-party hosts)
       =========================== -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' https://www.gstatic.com https://www.googleapis.com https://cdn.jsdelivr.net;
      connect-src 'self' https://firestore.googleapis.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com https://api64.ipify.org;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      frame-src https://accounts.google.com;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
    ">

  <!-- DOMPurify (for sanitization) -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <style>
    /* ---------- Layout & Theme (kept your original styling) ---------- */
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .back-button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background-color: #4caf50;
      color: white;
      font-size: 16px;
      cursor: pointer;
      width: 120px;
      position: fixed;
      bottom: 30px;
      right: 30px;
      transition: all 0.2s ease;
      animation: fadeInUp 1s ease-out;
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .back-button:hover {
      background-color: #45a049;
      transform: translateY(-2px);
      box-shadow: 0px 4px 12px rgba(0, 255, 0, 0.3);
    }

    .container {
      background-color: #1e1e1e;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0px 6px 16px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 400px;
      text-align: center;
      overflow: hidden;
      position: relative;
    }

    h1 { font-size: 32px; margin-bottom: 10px; }
    h2 { font-size: 16px; color: #aaa; margin-bottom: 20px; }

    .input-field {
      width: 80%;
      padding: 14px;
      margin: 12px 0;
      background-color: #2c2c2c;
      border: none;
      border-radius: 8px;
      color: #ffffff;
      font-size: 16px;
    }

    .input-field:focus {
      outline: none;
      border: 2px solid #4caf50;
      background-color: #333333;
    }

    .btn, .google-login {
      padding: 14px;
      border-radius: 8px;
      background-color: #4caf50;
      color: white;
      font-size: 16px;
      cursor: pointer;
      width: 60%;
      margin-top: 12px;
      border: none;
      transition: all 0.2s ease;
    }

    .btn:hover, .google-login:hover {
      background-color: #45a049;
      transform: translateY(-2px);
      box-shadow: 0px 4px 12px rgba(0, 255, 0, 0.3);
    }

    .message { color: #4caf50; font-size: 14px; margin-top: 12px; }
    .error { color: red; }
    .link-button {
      background: none;
      border: none;
      color: #4caf50;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin: 8px auto;
      display: block;
    }

    /* ---------- Animation for form switching ---------- */
    .forms-wrapper {
      position: relative;
      height: 360px; /* Enough to contain both forms */
    }

    .form-panel {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 360px;
      transition: transform 320ms ease, opacity 320ms ease, visibility 320ms;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .form-panel.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translate(-50%, -50%) translateY(0);
    }

    /* Slight slide for appearance */
    .form-panel.enter-from-right {
      transform: translate(-50%, -50%) translateX(20px);
    }

    .form-panel.enter-from-left {
      transform: translate(-50%, -50%) translateX(-20px);
    }

    /* Responsive tweak */
    @media (max-width: 480px) {
      .container { padding: 24px; width: 92%; }
      .forms-wrapper { height: auto; }
      .form-panel { position: static; transform: none; visibility: visible; opacity: 1; pointer-events: auto; }
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="forms-wrapper" id="formsWrapper">
      <!-- Login Form -->
      <div id="loginForm" class="form-panel active enter-from-left" aria-hidden="false">
        <h1>Login</h1>
        <h2>Use your username and password</h2>
        <input type="text" id="username" class="input-field" placeholder="Username" required autocomplete="username" />
        <input type="password" id="password" class="input-field" placeholder="Password" required autocomplete="current-password" />
        <button class="btn" id="loginBtn">Login</button>
        <button class="google-login" id="googleLoginBtn">Login With Google</button>
        <button class="link-button" id="forgotBtn">Forgot Password?</button>
        <p class="message">Don't have an account? <a href="#" id="showRegisterLink">Sign Up</a></p>
      </div>

      <!-- Register Form -->
      <div id="registerForm" class="form-panel enter-from-right" aria-hidden="true">
        <h1>Sign Up</h1>
        <h2>Create a new account</h2>
        <input type="text" id="regUsername" class="input-field" placeholder="Username" required autocomplete="username" />
        <input type="email" id="regEmail" class="input-field" placeholder="Email" required autocomplete="email" />
        <input type="password" id="regPassword" class="input-field" placeholder="Password" required autocomplete="new-password" />
        <button class="btn" id="registerBtn">Sign Up</button>
        <button class="google-login" id="googleRegisterBtn">Sign Up With Google</button>
        <p class="message">Already have an account? <a href="#" id="showLoginLink">Login</a></p>
        <p class="message">By signing up, you agree to our <a href="other/TOS">Terms of Service</a> and <a href="other/privicypolicy">Privacy Policy</a>.</p>
        <p class="message">We do not allow disposable or temporary email addresses for registration.</p>
        <p class="message">Please ensure your email is valid and accessible.</p>
        <p id="regStatus" class="message"></p>
      </div>
    </div>
  </div>

  <button class="back-button" id="backBtn" type="button">Back</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Ensure DOM ready before wiring event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // ---------- Firebase configuration (kept as provided) ----------
      const firebaseConfig = {
        apiKey: "AIzaSyBHSuqEhGYcRd_6GsMDI0bHDy3_5v0lD9g",
        authDomain: "multitools-48cc8.firebaseapp.com",
        projectId: "multitools-48cc8",
        storageBucket: "multitools-48cc8.appspot.com",
        messagingSenderId: "1048886823672",
        appId: "1:1048886823672:web:71f0ff40e2a9642de2890d",
        measurementId: "G-JG6J0KRN08"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // ---------- Full disposable email list (kept your content, trimmed duplicates) ----------
      const disposableEmailDomains = [
        "mailinator.com","10minutemail.com","guerrillamail.com","trashmail.com","tempmail.com",
        "fakeinbox.com","maildrop.cc","temp-mail.org","yopmail.com","getnada.com",
        "dispostable.com","spamgourmet.com","mailnesia.com","moakt.com","tempinbox.com",
        "mytemp.email","dropmail.me","fake-mail.net","temp-mail.io","mintemail.com",
        "trashmail.net","mailcatch.com","spambox.us","discard.email","tempemail.co",
        "disposablemail.com","sharklasers.com","emailondeck.com","mail-temporaire.fr",
        "trashmail.de","spammotel.com","mail-temp.com","10minemail.com","tempemail.net",
        "getairmail.com","discardmail.com","emailtemp.org","my10minutemail.com","jetable.org",
        "spambox.info","tempinbox.me","guerrillamail.net","fakemailgenerator.com","disposable-email.org",
        "mail-temporaire.com","tempemailaddress.com","temp-mail.com","throwawaymail.com","mailinator.net",
        "10minutemail.net","guerrillamail.org","tempmail.net","fakeinbox.net","maildrop.net",
        "temp-mail.net","yopmail.net","getnada.net","dispostable.net","mailnesia.net",
        "moakt.net","tempinbox.net","dropmail.cc","fake-mail.com","mintemail.net","trashmail.org",
        "yopmail.org","spam4.me","spamdecoy.net","trashmail.ws"
      ];

      function isDisposableEmail(email) {
        const domain = (email.split('@')[1] || '').toLowerCase();
        return disposableEmailDomains.includes(domain);
      }

      // ---------- Sanitization ----------
      function sanitizeInput(input) {
        if (typeof input !== 'string') return '';
        return DOMPurify.sanitize(input.trim());
      }

      // ---------- Utils ----------
      function formatTimestamp(date) {
        const pad = n => n.toString().padStart(2, '0');
        return `${pad(date.getMonth() + 1)}/${pad(date.getDate())}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
      }

      async function collectUserInfo(userId, email, username) {
        try {
          const response = await fetch('https://api64.ipify.org?format=json');
          const data = await response.json();
          const ip = data.ip;
          const formattedTimestamp = formatTimestamp(new Date());
          const userAgent = navigator.userAgent;
          const language = navigator.language || navigator.userLanguage;
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

          // Update user document (assumes it exists)
          await db.collection("users").doc(userId).update({
            emailLogged: email,
            usernameLogged: username,
            ipAddress: ip,
            lastSeenFormatted: formattedTimestamp,
            userAgent,
            language,
            timezone
          });
        } catch (error) {
          console.warn("Failed to collect user info:", error);
        }
      }

      // ---------- Auth functions ----------
      async function login() {
        const username = sanitizeInput(document.getElementById('username').value);
        const password = document.getElementById('password').value;

        if (!username || !password) {
          alert("Please enter username and password.");
          return;
        }

        try {
          const userQuery = await db.collection("users").where("username", "==", username).limit(1).get();
          if (userQuery.empty) {
            alert("No account found with that username.");
            return;
          }

          const userDoc = userQuery.docs[0];
          const email = userDoc.data().email;

          await auth.signInWithEmailAndPassword(email, password);
          // Signed in — redirect
          window.location.href = "index.html";
        } catch (error) {
          alert("Login failed: " + sanitizeInput(error.message || String(error)));
        }
      }

      async function register() {
        const email = sanitizeInput(document.getElementById('regEmail').value);
        const password = document.getElementById('regPassword').value;
        const username = sanitizeInput(document.getElementById('regUsername').value);
        const status = document.getElementById('regStatus');

        status.classList.remove('error');
        status.textContent = '';

        if (!username || !email || !password) {
          status.textContent = "Please fill in all fields.";
          status.classList.add('error');
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          status.textContent = "Invalid email format.";
          status.classList.add('error');
          return;
        }

        if (isDisposableEmail(email)) {
          status.textContent = "Disposable or temporary emails are not allowed.";
          status.classList.add('error');
          return;
        }

        try {
          const snapshot = await db.collection("users").where("username", "==", username).get();
          if (!snapshot.empty) {
            status.textContent = "Username is already taken.";
            status.classList.add('error');
            return;
          }

          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          await db.collection("users").doc(user.uid).set({
            username,
            email,
            createdAt: new Date(),
            role: "user",
          });

          await collectUserInfo(user.uid, email, username);

          status.textContent = "Registered successfully!";
          status.classList.remove('error');
        } catch (error) {
          status.textContent = "Registration failed: " + sanitizeInput(error.message || String(error));
          status.classList.add('error');
        }
      }

      function forgotPassword() {
        const email = prompt("Enter your email to reset your password:");
        if (!email) return;

        auth.sendPasswordResetEmail(sanitizeInput(email))
          .then(() => alert("Password reset email sent to " + sanitizeInput(email)))
          .catch(error => alert("Error sending reset email: " + sanitizeInput(error.message || String(error))));
      }

      async function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          const result = await auth.signInWithPopup(provider);
          const user = result.user;
          const userDoc = await db.collection("users").doc(user.uid).get();

          if (!userDoc.exists) {
            const username = user.displayName || ("UnnamedUser" + Math.floor(Math.random() * 10000));
            await db.collection("users").doc(user.uid).set({
              username,
              email: user.email,
              createdAt: new Date(),
              role: "user",
            });
            await collectUserInfo(user.uid, user.email, username);
          }

          window.location.href = "index.html";
        } catch (error) {
          alert("Google login failed: " + sanitizeInput(error.message || String(error)));
        }
      }

      // ---------- UI toggles with animation ----------
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');

      function showRegister(event) {
        if (event) event.preventDefault();
        loginForm.classList.remove('active');
        loginForm.setAttribute('aria-hidden', 'true');

        registerForm.classList.add('active');
        registerForm.setAttribute('aria-hidden', 'false');
      }

      function showLogin(event) {
        if (event) event.preventDefault();
        registerForm.classList.remove('active');
        registerForm.setAttribute('aria-hidden', 'true');

        loginForm.classList.add('active');
        loginForm.setAttribute('aria-hidden', 'false');
      }

      // ---------- Event listeners (no inline JS) ----------
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('registerBtn').addEventListener('click', register);
      document.getElementById('googleLoginBtn').addEventListener('click', googleLogin);
      document.getElementById('googleRegisterBtn').addEventListener('click', googleLogin);
      document.getElementById('forgotBtn').addEventListener('click', forgotPassword);
      document.getElementById('showRegisterLink').addEventListener('click', showRegister);
      document.getElementById('showLoginLink').addEventListener('click', showLogin);
      document.getElementById('backBtn').addEventListener('click', () => window.history.back());

      // Optional: Enter key submits login when focused on password
      document.getElementById('password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') login();
      });
      document.getElementById('regPassword').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') register();
      });

      // Accessibility: ensure first field receives focus
      document.getElementById('username').focus();
    }); // DOMContentLoaded end
  </script>
</body>
</html>